<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image OCR Demo (for your own images)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --fg: #e5e7eb;
      --accent: #22c55e;
      --accent-2: #3b82f6;
      --warn: #f59e0b;
      --error: #ef4444;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 1200px at 10% -10%, #112 0%, var(--bg) 35%, #0a0f26 95%);
      color: var(--fg);
      min-height: 100vh;
      line-height: 1.45;
    }
    header {
      padding: 28px 20px 10px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.3px;
    }
    header p {
      margin: 8px auto 0;
      color: var(--muted);
      max-width: 820px;
      font-size: 14px;
    }
    .app {
      max-width: 980px;
      margin: 18px auto 48px;
      padding: 0 16px;
    }
    .panel {
      background: linear-gradient(180deg, #0c1224, #0c1326);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.30), inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }
    input[type="text"] {
      flex: 1;
      min-width: 260px;
      background: #0b1022;
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 12px;
      outline: none;
      font-size: 14px;
      transition: border 0.15s ease, box-shadow 0.15s ease;
    }
    input[type="text"]:focus {
      border-color: #2a4670;
      box-shadow: 0 0 0 4px rgba(59,130,246,0.12);
    }
    button {
      background: linear-gradient(180deg, #1a2e4d, #14233d);
      border: 1px solid #203352;
      color: #dbeafe;
      padding: 12px 14px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.03s ease, filter 0.15s ease, border 0.15s ease;
      user-select: none;
    }
    button:hover { filter: brightness(1.06); }
    button:active { transform: translateY(1px); }
    button.primary {
      background: linear-gradient(180deg, #1c7c43, #146235);
      border: 1px solid #228e4d;
      color: #eafff3;
    }
    button.secondary {
      background: linear-gradient(180deg, #244064, #1c2f4b);
      border: 1px solid #2e4770;
      color: #deebff;
    }
    button.warn {
      background: linear-gradient(180deg, #7a4f14, #5a3a10);
      border: 1px solid #8a5c17;
      color: #fff1da;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 920px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      background: #0b1022;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      min-height: 120px;
      position: relative;
    }
    .dropzone {
      display: grid;
      place-items: center;
      text-align: center;
      gap: 8px;
      padding: 18px;
      border: 1px dashed #2a3a5a;
      border-radius: 10px;
      color: var(--muted);
      min-height: 120px;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .dropzone.dragover {
      background: rgba(59,130,246,0.10);
      border-color: #3b82f6;
      color: #bfdbfe;
    }
    .img-wrap {
      display: grid;
      place-items: center;
      background: #0a0f1f;
      border-radius: 8px;
      border: 1px solid #1a2236;
      padding: 8px;
      min-height: 160px;
      overflow: hidden;
    }
    .img-wrap img, .img-wrap canvas {
      max-width: 100%;
      max-height: 360px;
      image-rendering: crisp-edges;
      background: #fff;
    }
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .toggle {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #2a3a5a;
      color: #d1e0ff;
      background: #0e1730;
      font-size: 12px;
      user-select: none;
    }
    .muted {
      color: var(--muted);
      font-size: 12px;
    }
    .out {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 14px;
      white-space: pre-wrap;
      color: #d1fae5;
      background: #06150f;
      border: 1px solid #153b2e;
      border-radius: 10px;
      padding: 12px;
      min-height: 60px;
    }
    .progress {
      position: relative;
      height: 8px;
      background: #0b1328;
      border: 1px solid #1c2a48;
      border-radius: 100px;
      overflow: hidden;
    }
    .bar {
      position: absolute;
      top: 0; left: 0; bottom: 0;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width 0.2s ease;
    }
    .small {
      font-size: 12px;
      color: var(--muted);
    }
    .kbd {
      display: inline-block;
      padding: 2px 6px;
      border: 1px solid #2a3a5a;
      border-bottom-width: 3px;
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: #0a1022;
      color: #c6d2f3;
      font-size: 12px;
    }
    footer {
      text-align: center;
      margin: 26px 0 40px;
      color: var(--muted);
      font-size: 12px;
    }
    .note {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #3a2a1a;
      background: #1a120a;
      color: #ffd79b;
      border-radius: 8px;
    }
    .error {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #5d1b1b;
      background: #1f0b0b;
      color: #ffb4b4;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Image OCR Demo (for your own images)</h1>
    <p>
      Loads an image from the url parameter or local file and extracts visible text with on-device OCR.
      This is intended for accessibility, QA, and processing your own test images. Do not use it to bypass third‑party anti-bot systems.
    </p>
  </header>

  <div class="app">
    <div class="panel">
      <div class="row" style="gap:12px;">
        <div style="flex:1; min-width: 260px;">
          <label for="url">Image URL (or use query param ?url=...)</label>
          <input id="url" type="text" placeholder="https://example.com/image.png" />
        </div>
        <div class="row" style="gap:8px;">
          <button id="btnLoad" class="secondary" title="Load the image from URL">Load</button>
          <button id="btnSolve" class="primary" title="Run OCR on the current image">Solve</button>
          <button id="btnCopy" class="secondary" title="Copy recognized text">Copy</button>
          <button id="btnSample" class="warn" title="Insert a synthetic sample image">Use Sample</button>
        </div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="card">
          <div class="row" style="justify-content: space-between; align-items: baseline;">
            <div>
              <strong>Input</strong>
              <div class="small">Paste URL above, drop an image, or use the sample.</div>
            </div>
            <div>
              <input id="file" type="file" accept="image/*" style="display:none;" />
              <button id="btnFile" class="secondary">Choose File</button>
            </div>
          </div>

          <div id="drop" class="dropzone" style="margin-top:10px;">
            <div>
              <div>Drop image here</div>
              <div class="small">or click to browse (<span class="kbd">.png</span> <span class="kbd">.jpg</span> <span class="kbd">.gif</span>)</div>
            </div>
          </div>

          <div class="img-wrap" style="margin-top:10px;">
            <img id="img" alt="Input" crossorigin="anonymous" />
            <canvas id="preCanvas" style="display:none;"></canvas>
          </div>

          <div class="controls">
            <label class="toggle"><input id="chkPre" type="checkbox" /> Preprocess (threshold)</label>
            <input id="thr" type="range" min="10" max="245" value="160" />
            <span class="muted">Threshold: <span id="thrVal">160</span></span>
            <label class="toggle"><input id="chkInvert" type="checkbox" /> Invert</label>
            <label class="toggle"><input id="chkSharpen" type="checkbox" /> Sharpen</label>
          </div>

          <div id="imgInfo" class="small" style="margin-top:8px;"></div>
          <div id="corsNote" class="note" style="display:none;">
            Heads-up: This image is from another domain without CORS. Preprocessing may be disabled and OCR accuracy may be lower.
            If you own the image, enable CORS or download and open it locally.
          </div>
          <div id="errBox" class="error" style="display:none;"></div>
        </div>

        <div class="card">
          <div class="row" style="justify-content: space-between; align-items: baseline;">
            <strong>Result</strong>
            <div class="small">Language: English (default)</div>
          </div>
          <div class="out" id="out" style="margin-top:10px;"></div>

          <div style="margin-top:12px;">
            <div class="progress"><div id="bar" class="bar"></div></div>
            <div id="status" class="small" style="margin-top:6px;">Idle</div>
          </div>
        </div>
      </div>

      <div class="note" style="margin-top:12px;">
        Ethical use: Do not use this to defeat anti‑bot challenges on services you don’t own. For testing your own challenges, consider adding CORS headers to your image server to enable better on‑device preprocessing.
      </div>
    </div>

    <footer>
      Tip: You can load an image by navigating to this page with ?url=https://.../image.png
    </footer>
  </div>

  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script>
    const $ = sel => document.querySelector(sel);
    const urlInput = $('#url');
    const btnLoad = $('#btnLoad');
    const btnSolve = $('#btnSolve');
    const btnCopy = $('#btnCopy');
    const btnSample = $('#btnSample');
    const img = $('#img');
    const drop = $('#drop');
    const fileBtn = $('#btnFile');
    const fileInput = $('#file');
    const preCanvas = $('#preCanvas');
    const chkPre = $('#chkPre');
    const thr = $('#thr');
    const thrVal = $('#thrVal');
    const chkInvert = $('#chkInvert');
    const chkSharpen = $('#chkSharpen');
    const out = $('#out');
    const bar = $('#bar');
    const statusEl = $('#status');
    const infoEl = $('#imgInfo');
    const corsNote = $('#corsNote');
    const errBox = $('#errBox');

    let lastSourceDesc = '';
    let lastObjectUrl = null;

    function setStatus(text) {
      statusEl.textContent = text;
    }
    function setProgress(p) {
      bar.style.width = Math.round(100 * p) + '%';
    }
    function setError(msg) {
      if (!msg) {
        errBox.style.display = 'none';
        errBox.textContent = '';
      } else {
        errBox.style.display = 'block';
        errBox.textContent = msg;
      }
    }
    function getQueryParam(name) {
      const p = new URLSearchParams(window.location.search);
      return p.get(name);
    }
    function isSameOrigin(url) {
      try {
        const u = new URL(url, location.href);
        return u.origin === location.origin;
      } catch { return false; }
    }
    function revokeLastObjectUrl() {
      if (lastObjectUrl) {
        URL.revokeObjectURL(lastObjectUrl);
        lastObjectUrl = null;
      }
    }

    function setImageSrc(src, desc = '') {
      revokeLastObjectUrl();
      img.src = '';
      img.removeAttribute('data-tainted');
      corsNote.style.display = 'none';
      return new Promise((resolve, reject) => {
        img.onload = () => {
          infoEl.textContent = `Loaded ${desc || 'image'} • ${img.naturalWidth} × ${img.naturalHeight}`;
          resolve();
        };
        img.onerror = () => {
          reject(new Error('Failed to load image.'));
        };
        img.crossOrigin = 'anonymous'; // attempt to keep canvas untainted for preprocessing
        img.src = src;
        lastSourceDesc = desc;
      }).then(() => testTaint())
        .catch(e => {
          setError('Image load error. ' + e.message);
          throw e;
        });
    }

    async function testTaint() {
      // Draw a tiny sample to check if canvas becomes tainted
      const c = document.createElement('canvas');
      c.width = Math.min(2, img.naturalWidth || 2);
      c.height = Math.min(2, img.naturalHeight || 2);
      const ctx = c.getContext('2d');
      try {
        ctx.drawImage(img, 0, 0, c.width, c.height);
        // Attempt to read back pixels
        ctx.getImageData(0, 0, 1, 1);
        img.dataset.tainted = 'no';
      } catch {
        img.dataset.tainted = 'yes';
        corsNote.style.display = 'block';
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      drop.classList.remove('dragover');
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (file) loadFromFile(file);
    }
    function handleDragOver(e) {
      e.preventDefault();
      drop.classList.add('dragover');
    }
    function handleDragLeave() {
      drop.classList.remove('dragover');
    }

    function loadFromFile(file) {
      setError('');
      const url = URL.createObjectURL(file);
      lastObjectUrl = url;
      urlInput.value = '';
      return setImageSrc(url, file.name);
    }

    async function loadFromUrlField() {
      setError('');
      const value = (urlInput.value || '').trim();
      if (!value) {
        setError('Please enter an image URL.');
        return;
      }
      await setImageSrc(value, value);
    }

    function preprocessIfEnabled() {
      const wantPre = chkPre.checked && (img.dataset.tainted !== 'yes');
      if (!wantPre) {
        preCanvas.style.display = 'none';
        return img;
      }
      // draw and process
      const scaleMax = 1.5; // upsample slightly for OCR
      const scale = Math.min(scaleMax, 800 / Math.max(img.naturalWidth, img.naturalHeight) || 1);
      preCanvas.width = Math.round(img.naturalWidth * scale);
      preCanvas.height = Math.round(img.naturalHeight * scale);
      const ctx = preCanvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(img, 0, 0, preCanvas.width, preCanvas.height);

      let imageData = ctx.getImageData(0, 0, preCanvas.width, preCanvas.height);
      const data = imageData.data;
      // grayscale
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i+1], b = data[i+2];
        const gray = (r * 0.299 + g * 0.587 + b * 0.114) | 0;
        data[i] = data[i+1] = data[i+2] = gray;
      }
      // simple unsharp mask (optional)
      if (chkSharpen.checked) {
        imageData = unsharpMask(imageData, preCanvas.width, preCanvas.height);
      }
      // threshold
      const t = parseInt(thr.value, 10);
      const invert = chkInvert.checked;
      const d2 = imageData.data;
      for (let i = 0; i < d2.length; i += 4) {
        const v = d2[i];
        let bw = v > t ? 255 : 0;
        if (invert) bw = 255 - bw;
        d2[i] = d2[i+1] = d2[i+2] = bw;
        d2[i+3] = 255;
      }
      ctx.putImageData(imageData, 0, 0);
      preCanvas.style.display = 'block';
      return preCanvas;
    }

    function unsharpMask(srcImageData, w, h) {
      // Very small box blur + original to sharpen
      const src = srcImageData.data;
      const dst = new Uint8ClampedArray(src.length);
      const radius = 1;
      const amount = 0.6; // strength
      // Make grayscale copy (already grayscale) but we'll blur with a simple kernel
      const get = (x,y,c)=> src[((y*w + x)<<2) + c];
      const set = (x,y,c,v)=> dst[((y*w + x)<<2) + c] = v;
      for (let y=0;y<h;y++){
        for (let x=0;x<w;x++){
          let sum=0, count=0;
          for (let dy=-radius; dy<=radius; dy++){
            const yy = y+dy; if (yy<0||yy>=h) continue;
            for (let dx=-radius; dx<=radius; dx++){
              const xx = x+dx; if (xx<0||xx>=w) continue;
              sum += get(xx,yy,0); count++;
            }
          }
          const blur = sum / count;
          const orig = get(x,y,0);
          const sharp = Math.max(0, Math.min(255, orig + amount*(orig - blur)));
          set(x,y,0,sharp); set(x,y,1,sharp); set(x,y,2,sharp); set(x,y,3,255);
        }
      }
      const out = new ImageData(dst, w, h);
      return out;
    }

    async function solve() {
      setError('');
      out.textContent = '';
      setProgress(0);
      setStatus('Initializing OCR...');
      const input = preprocessIfEnabled();
      try {
        const result = await Tesseract.recognize(input, 'eng', {
          logger: m => {
            if (m.status) setStatus(m.status.replace(/\b(\w)/g, s=>s.toUpperCase()));
            if (m.progress != null) setProgress(m.progress);
          }
        });
        const text = (result && result.data && result.data.text) ? result.data.text.trim() : '';
        out.textContent = text || '(no text detected)';
        setStatus('Done');
        setProgress(1);
      } catch (err) {
        console.error(err);
        setError('OCR failed: ' + (err?.message || err));
        setStatus('Error');
      }
    }

    function copyOut() {
      const txt = out.textContent || '';
      if (!txt) return;
      navigator.clipboard?.writeText(txt).then(()=> {
        setStatus('Copied to clipboard');
        setTimeout(()=> setStatus('Idle'), 900);
      }).catch(()=>{});
    }

    function genSampleDataUrl() {
      // Generate a simple high-contrast test image
      const w = 320, h = 120;
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const ctx = c.getContext('2d');
      // background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,w,h);
      // border
      ctx.strokeStyle = '#e5e7eb';
      ctx.strokeRect(0.5,0.5,w-1,h-1);
      // text
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let text = '';
      for (let i=0;i<5;i++) text += chars[Math.floor(Math.random()*chars.length)];
      ctx.save();
      ctx.translate(0,0);
      ctx.font = '700 64px ui-sans-serif, Segoe UI, Roboto, Arial';
      ctx.fillStyle = '#111827';
      const tw = ctx.measureText(text).width;
      ctx.fillText(text, (w - tw)/2, 78);
      ctx.restore();
      // light noise dots
      ctx.globalAlpha = 0.15;
      ctx.fillStyle = '#1f2937';
      for (let i=0;i<120;i++){
        const x = Math.random()*w, y = Math.random()*h;
        ctx.fillRect(x, y, 1, 1);
      }
      ctx.globalAlpha = 1;
      return { url: c.toDataURL('image/png'), label: `Sample (${text})` };
    }

    async function useSample() {
      const { url, label } = genSampleDataUrl();
      urlInput.value = '';
      await setImageSrc(url, label);
      // Auto-enable reasonable preprocess defaults for sample
      chkPre.checked = true;
      thr.value = 160; thrVal.textContent = '160';
      chkInvert.checked = false;
      chkSharpen.checked = true;
    }

    function updateThrLabel() {
      thrVal.textContent = thr.value;
      if (chkPre.checked && img.src) {
        preprocessIfEnabled();
      }
    }

    function initFromQuery() {
      const q = getQueryParam('url');
      if (q) {
        urlInput.value = q;
        setImageSrc(q, q).catch(()=>{});
      } else {
        useSample();
      }
    }

    // Event bindings
    btnLoad.addEventListener('click', loadFromUrlField);
    btnSolve.addEventListener('click', solve);
    btnCopy.addEventListener('click', copyOut);
    btnSample.addEventListener('click', useSample);
    thr.addEventListener('input', updateThrLabel);
    chkPre.addEventListener('change', () => preprocessIfEnabled());
    chkInvert.addEventListener('change', () => preprocessIfEnabled());
    chkSharpen.addEventListener('change', () => preprocessIfEnabled());
    fileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      if (f) loadFromFile(f);
    });
    drop.addEventListener('click', () => fileInput.click());
    drop.addEventListener('dragover', handleDragOver);
    drop.addEventListener('dragleave', handleDragLeave);
    drop.addEventListener('drop', handleDrop);

    // Initialize
    updateThrLabel();
    initFromQuery();
  </script>
</body>
</html>